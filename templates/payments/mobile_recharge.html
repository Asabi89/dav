{% extends 'base.html' %}

{% block title %}Recharge mobile | OPay{% endblock %}

{% block extra_css %}
<style>
    /* Animation pour les éléments du formulaire */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .form-element {
        animation: fadeIn 0.3s ease-out forwards;
        animation-delay: calc(var(--animation-order) * 0.05s);
        opacity: 0;
    }
    
    /* Styles pour les champs de formulaire */
    .form-input {
        transition: all 0.3s ease;
        border-width: 2px;
    }
    
    .form-input:focus {
        border-color: #0d9488;
        box-shadow: 0 0 0 2px rgba(13, 148, 136, 0.2);
    }
    
    /* Styles pour les boutons de montant prédéfini */
    .amount-preset {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .amount-preset:hover {
        background-color: #f3f4f6;
        transform: translateY(-2px);
    }
    
    .amount-preset.active {
        background-color: #0d9488;
        color: white;
        border-color: #0d9488;
    }
    
    /* Styles pour le bouton de confirmation */
    .submit-button {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .submit-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .submit-button::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 5px;
        background: rgba(255, 255, 255, 0.5);
        opacity: 0;
        border-radius: 100%;
        transform: scale(1, 1) translate(-50%);
        transform-origin: 50% 50%;
    }
    
    .submit-button:focus:not(:active)::after {
        animation: ripple 1s ease-out;
    }
    
    @keyframes ripple {
        0% {
            transform: scale(0, 0);
            opacity: 0.5;
        }
        100% {
            transform: scale(20, 20);
            opacity: 0;
        }
    }
    
    /* Styles pour les forfaits data */
    .data-plan-card {
        transition: all 0.3s ease;
        cursor: pointer;
        border: 2px solid transparent;
    }
    
    .data-plan-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .data-plan-card.selected {
        border-color: #0d9488;
        background-color: #f0fdfa;
    }
    
    /* Animation pour les messages */
    .message-animation {
        animation: slideIn 0.5s ease-out forwards;
    }
    
    @keyframes slideIn {
        0% {
            transform: translateY(-20px);
            opacity: 0;
        }
        100% {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    /* Styles pour le récapitulatif */
    .summary-container {
        background: linear-gradient(135deg, #f0fdfa 0%, #e0f2fe 100%);
        border-radius: 0.75rem;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    /* Styles pour les contacts récents */
    .recent-contact {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .recent-contact:hover {
        background-color: #f3f4f6;
    }
    
    /* Styles pour l'indicateur de chargement */
    .loading-indicator {
        display: none;
        align-items: center;
        justify-content: center;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 0.5rem;
        z-index: 10;
    }
    
    .spinner {
        width: 2rem;
        height: 2rem;
        border: 3px solid #e5e7eb;
        border-top-color: #0d9488;
        border-radius: 50%;
        animation: spinner 0.8s linear infinite;
    }
    
    @keyframes spinner {
        to {
            transform: rotate(360deg);
        }
    }
    
    /* Styles pour le clavier numérique */
    .numpad {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
    }
    
    .numpad-key {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        font-weight: 600;
        background-color: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .numpad-key:hover {
        background-color: #f3f4f6;
    }
    
    .numpad-key:active {
        transform: scale(0.95);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-4xl">
    <!-- En-tête avec titre et bouton retour -->
    <div class="mb-6">
        <div class="flex items-center mb-2">
            <a href="{% url 'mobile_operators' %}" class="text-primary-600 mr-2 hover:text-primary-700 transition-colors">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1 class="text-2xl font-bold text-gray-800">Recharge mobile</h1>
        </div>
        <p class="text-gray-600">Remplissez les informations pour effectuer votre recharge</p>
    </div>
    
    <!-- Messages d'alerte -->
    {% if messages %}
    <div class="mb-6">
        {% for message in messages %}
        <div class="p-4 mb-4 rounded-xl message-animation {% if message.tags == 'error' %}bg-red-100 text-red-700 border border-red-200{% elif message.tags == 'success' %}bg-green-100 text-green-700 border border-green-200{% else %}bg-blue-100 text-blue-700 border border-blue-200{% endif %}">
            <div class="flex items-center">
                {% if message.tags == 'error' %}
                    <i class="fas fa-exclamation-circle mr-2 text-red-500"></i>
                {% elif message.tags == 'success' %}
                    <i class="fas fa-check-circle mr-2 text-green-500"></i>
                {% else %}
                    <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                {% endif %}
                {{ message }}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Formulaire de recharge (2/3 de la largeur sur desktop) -->
        <div class="md:col-span-2">
            <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200 mb-6 relative">
                <!-- Indicateur de chargement -->
                <div id="loadingIndicator" class="loading-indicator">
                    <div class="spinner"></div>
                </div>
                
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-mobile-alt text-primary-600 mr-2"></i>
                            Détails de la recharge
                        </h2>
                        
                        <!-- Opérateur sélectionné (si disponible) -->
                        {% if selected_operator %}
                        <div class="flex items-center">
                            {% if selected_operator.logo %}
                            <img src="{{ selected_operator.logo.url }}" alt="{{ selected_operator.name }}" class="h-8 w-8 object-contain mr-2">
                            {% endif %}
                            <span class="font-medium">{{ selected_operator.name }}</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <form method="post" action="" id="rechargeForm">
                        {% csrf_token %}
                        
                        <!-- Sélection de l'opérateur -->
                        <div class="mb-5 form-element" style="--animation-order: 1">
                            <label for="{{ form.operator.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                Opérateur
                            </label>
                            {{ form.operator }}
                            {% if form.operator.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.operator.errors }}</p>
                            {% endif %}
                        </div>
                        
                        <!-- Contacts récents (si disponible) -->
                        <div id="recentContactsContainer" class="mb-4 form-element" style="--animation-order: 2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Contacts récents
                            </label>
                            <div class="flex flex-wrap gap-2">
                                {% for contact in recent_contacts|default:'' %}
                                <div class="recent-contact px-3 py-2 bg-gray-100 rounded-full flex items-center" data-number="{{ contact.phone_number }}">
                                    <i class="fas fa-user-circle text-gray-500 mr-2"></i>
                                    <span class="text-sm">{{ contact.phone_number }}</span>
                                </div>
                                {% empty %}
                                <p class="text-sm text-gray-500">Aucun contact récent</p>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Numéro de téléphone -->
                        <div class="mb-5 form-element" style="--animation-order: 3">
                            <label for="{{ form.phone_number.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                Numéro de téléphone
                            </label>
                            <div class="relative">
                                {{ form.phone_number }}
                                <button type="button" id="contactsBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-address-book"></i>
                                </button>
                            </div>
                            {% if form.phone_number.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.phone_number.errors }}</p>
                            {% endif %}
                            <p class="text-xs text-gray-500 mt-1">Format international (ex: +33612345678)</p>
                        </div>
                        
                        <!-- Forfaits data (affichage en grille) -->
                        <div id="dataPlansGrid" class="mb-5 grid grid-cols-1 sm:grid-cols-2 gap-3 form-element" style="--animation-order: 4; display: none;">
                            <h3 class="col-span-full text-sm font-medium text-gray-700 mb-1">
                                Forfaits disponibles
                            </h3>
                            <!-- Les forfaits seront ajoutés ici dynamiquement -->
                        </div>
                        
                        <!-- Montants prédéfinis -->
                        <div class="mb-5 form-element" style="--animation-order: 5">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Montants suggérés
                            </label>
                            <div class="grid grid-cols-3 sm:grid-cols-4 gap-2">
                                <div class="amount-preset px-3 py-2 bg-white border border-gray-300 rounded-md text-center" data-amount="5">
                                    5 €
                                </div>
                                <div class="amount-preset px-3 py-2 bg-white border border-gray-300 rounded-md text-center" data-amount="10">
                                    10 €
                                </div>
                                <div class="amount-preset px-3 py-2 bg-white border border-gray-300 rounded-md text-center" data-amount="20">
                                    20 €
                                </div>
                                <div class="amount-preset px-3 py-2 bg-white border border-gray-300 rounded-md text-center" data-amount="50">
                                    50 €
                                </div>
                            </div>
                        </div>
                        
                        <!-- Montant personnalisé -->
                        <div class="mb-6 form-element" style="--animation-order: 6">
                            <label for="{{ form.amount.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                Montant (€)
                            </label>
                            <div class="relative">
                                {{ form.amount }}
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500">€</span>
                                </div>
                            </div>
                            {% if form.amount.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.amount.errors }}</p>
                            {% endif %}
                        </div>
                        
                                              <!-- Bouton de confirmation -->
                                              <button type="submit" id="submitBtn" class="submit-button w-full px-4 py-3 bg-primary-600 text-white hover:bg-primary-700 rounded-md font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 border border-primary-700 flex items-center justify-center form-element" style="--animation-order: 7">
                                                <i class="fas fa-check-circle mr-2"></i> Confirmer la recharge
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                
                                <!-- Informations supplémentaires -->
                                <div class="bg-blue-50 rounded-xl p-4 border border-blue-200 mb-6">
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-info-circle text-blue-500 mt-1"></i>
                                        </div>
                                        <div class="ml-3">
                                            <h3 class="text-sm font-medium text-blue-800">Information</h3>
                                            <div class="mt-2 text-sm text-blue-700">
                                                <p>La recharge sera créditée immédiatement sur le numéro indiqué. Assurez-vous que le numéro est correct avant de confirmer.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Historique des recharges récentes -->
                                <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200 mb-6">
                                    <div class="p-4 border-b border-gray-100">
                                        <h3 class="font-medium text-gray-800">Recharges récentes</h3>
                                    </div>
                                    <div id="recentRecharges">
                                        {% for recharge in recent_recharges|default:'' %}
                                        <div class="p-4 {% if not forloop.last %}border-b border-gray-100{% endif %}">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center">
                                                    <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                                                        <i class="fas fa-mobile-alt text-primary-600"></i>
                                                    </div>
                                                    <div>
                                                        <p class="font-medium text-gray-800">{{ recharge.phone_number }}</p>
                                                        <p class="text-xs text-gray-500">{{ recharge.created_at|date:"d/m/Y H:i" }}</p>
                                                    </div>
                                                </div>
                                                <div class="text-right">
                                                    <p class="font-bold text-gray-800">{{ recharge.amount }} €</p>
                                                    <span class="text-xs px-2 py-1 rounded-full {% if recharge.status == 'success' %}bg-green-100 text-green-800{% elif recharge.status == 'pending' %}bg-yellow-100 text-yellow-800{% else %}bg-red-100 text-red-800{% endif %}">
                                                        {{ recharge.get_status_display }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        {% empty %}
                                        <div class="p-4 text-center text-gray-500">
                                            Aucune recharge récente
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Panneau latéral (1/3 de la largeur sur desktop) -->
                            <div class="md:col-span-1">
                                <!-- Solde du portefeuille -->
                                <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200 mb-6">
                                    <div class="p-4 bg-gradient-to-r from-primary-600 to-primary-700 text-white">
                                        <h3 class="font-medium">Solde disponible</h3>
                                    </div>
                                    <div class="p-4 text-center">
                                        <p class="text-3xl font-bold text-primary-600">{{ wallet.balance }} €</p>
                                        <p class="text-sm text-gray-500 mt-1">sur votre compte OPay</p>
                                        
                                        {% if wallet.balance < 5 %}
                                        <div class="mt-4">
                                            <a href="{% url 'wallet_deposit' %}" class="px-4 py-2 bg-primary-600 text-white rounded-md text-sm font-medium hover:bg-primary-700 inline-block">
                                                Recharger mon compte
                                            </a>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Récapitulatif de la transaction -->
                                <div id="transactionSummary" class="summary-container mb-6 hidden">
                                    <div class="p-4 border-b border-teal-100">
                                        <h3 class="font-medium text-gray-800">Récapitulatif</h3>
                                    </div>
                                    <div class="p-4">
                                        <div class="space-y-3">
                                            <div class="flex justify-between items-center">
                                                <span class="text-gray-600">Opérateur</span>
                                                <span id="summaryOperator" class="font-medium">-</span>
                                            </div>
                                            
                                            <div class="flex justify-between items-center">
                                                <span class="text-gray-600">Numéro</span>
                                                <span id="summaryPhone" class="font-medium">-</span>
                                            </div>
                                            
                                            <div class="flex justify-between items-center">
                                                <span class="text-gray-600">Forfait</span>
                                                <span id="summaryPlan" class="font-medium">-</span>
                                            </div>
                                            
                                            <div class="flex justify-between items-center pt-2 border-t border-teal-100">
                                                <span class="text-gray-600">Montant</span>
                                                <span id="summaryAmount" class="font-bold text-primary-600">-</span>
                                            </div>
                                            
                                            <div class="flex justify-between items-center">
                                                <span class="text-gray-600">Frais</span>
                                                <span id="summaryFees" class="font-medium">0.00 €</span>
                                            </div>
                                            
                                            <div class="flex justify-between items-center pt-2 border-t border-teal-100">
                                                <span class="text-gray-700 font-medium">Total</span>
                                                <span id="summaryTotal" class="font-bold text-lg text-primary-600">-</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Aide et support -->
                                <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0 mr-3">
                                            <i class="fas fa-question-circle text-primary-600 text-xl"></i>
                                        </div>
                                        <div>
                                            <h3 class="text-md font-semibold text-gray-800 mb-2">Besoin d'aide ?</h3>
                                            <p class="text-sm text-gray-600 mb-3">
                                                Si vous rencontrez des difficultés avec votre recharge ou si vous avez des questions, notre équipe de support est disponible pour vous aider.
                                            </p>
                                            <a href="{% url 'contact' %}" class="text-primary-600 hover:text-primary-700 text-sm font-medium flex items-center">
                                                Contacter le support <i class="fas fa-arrow-right ml-1"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Modal pour le clavier numérique -->
                        <div id="numpadModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                            <div class="bg-white rounded-lg p-6 max-w-xs w-full mx-4">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-bold text-gray-900">Entrer un numéro</h3>
                                    <button id="closeNumpadBtn" class="text-gray-400 hover:text-gray-500">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                
                                <input type="text" id="numpadInput" class="w-full px-4 py-2 border-2 border-gray-300 rounded-md mb-4 text-center text-xl font-medium" readonly>
                                
                                <div class="numpad mb-4">
                                    <div class="numpad-key" data-key="1">1</div>
                                    <div class="numpad-key" data-key="2">2</div>
                                    <div class="numpad-key" data-key="3">3</div>
                                    <div class="numpad-key" data-key="4">4</div>
                                    <div class="numpad-key" data-key="5">5</div>
                                    <div class="numpad-key" data-key="6">6</div>
                                    <div class="numpad-key" data-key="7">7</div>
                                    <div class="numpad-key" data-key="8">8</div>
                                    <div class="numpad-key" data-key="9">9</div>
                                    <div class="numpad-key" data-key="+">+</div>
                                    <div class="numpad-key" data-key="0">0</div>
                                    <div class="numpad-key" data-key="backspace">
                                        <i class="fas fa-backspace"></i>
                                    </div>
                                </div>
                                
                                <button id="confirmNumpadBtn" class="w-full px-4 py-2 bg-primary-600 text-white rounded-md font-medium hover:bg-primary-700">
                                    Confirmer
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endblock %}
                    
                    {% block extra_js %}
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            // Éléments DOM
                            const operatorSelect = document.getElementById('{{ form.operator.id_for_label }}');
                            const phoneNumberInput = document.getElementById('{{ form.phone_number.id_for_label }}');
                            const amountInput = document.getElementById('{{ form.amount.id_for_label }}');
                            const dataPlansGrid = document.getElementById('dataPlansGrid');
                            const rechargeForm = document.getElementById('rechargeForm');
                            const loadingIndicator = document.getElementById('loadingIndicator');
                            const amountPresets = document.querySelectorAll('.amount-preset');
                            const transactionSummary = document.getElementById('transactionSummary');
                            const summaryOperator = document.getElementById('summaryOperator');
                            const summaryPhone = document.getElementById('summaryPhone');
                            const summaryPlan = document.getElementById('summaryPlan');
                            const summaryAmount = document.getElementById('summaryAmount');
                            const summaryFees = document.getElementById('summaryFees');
                            const summaryTotal = document.getElementById('summaryTotal');
                            const recentContacts = document.querySelectorAll('.recent-contact');
                            const contactsBtn = document.getElementById('contactsBtn');
                            const numpadModal = document.getElementById('numpadModal');
                            const numpadInput = document.getElementById('numpadInput');
                            const numpadKeys = document.querySelectorAll('.numpad-key');
                            const closeNumpadBtn = document.getElementById('closeNumpadBtn');
                            const confirmNumpadBtn = document.getElementById('confirmNumpadBtn');
                            
                            // Variables globales
                            let selectedPlanId = null;
                            let selectedPlanName = null;
                            
                            // Fonction pour mettre à jour le récapitulatif
                            function updateSummary() {
                                const operatorText = operatorSelect.options[operatorSelect.selectedIndex]?.text || '-';
                                const phoneText = phoneNumberInput.value || '-';
                                const amountText = amountInput.value ? `${amountInput.value} €` : '-';
                                const planText = selectedPlanName || 'Recharge standard';
                                const totalAmount = parseFloat(amountInput.value) || 0;
                                
                                summaryOperator.textContent = operatorText;
                                summaryPhone.textContent = phoneText;
                                summaryPlan.textContent = planText;
                                summaryAmount.textContent = amountText;
                                summaryTotal.textContent = `${totalAmount.toFixed(2)} €`;
                                
                                // Afficher le récapitulatif si les champs sont remplis
                                if (operatorSelect.value && phoneNumberInput.value && amountInput.value) {
                                    transactionSummary.classList.remove('hidden');
                                } else {
                                    transactionSummary.classList.add('hidden');
                                }
                            }
                            
                            // Fonction pour charger les forfaits data
                            function loadDataPlans(operatorId) {
                                if (!operatorId) {
                                    dataPlansGrid.style.display = 'none';
                                    return;
                                }
                                
                                // Afficher l'indicateur de chargement
                                loadingIndicator.style.display = 'flex';
                                
                                // Récupérer les forfaits pour l'opérateur sélectionné
                                fetch(`/payments/get-data-plans/?operator_id=${operatorId}`)
                                    .then(response => response.json())
                                    .then(data => {
                                        // Masquer l'indicateur de chargement
                                        loadingIndicator.style.display = 'none';
                                        
                                        if (data.data_plans && data.data_plans.length > 0) {
                                            // Vider la grille
                                            dataPlansGrid.innerHTML = '<h3 class="col-span-full text-sm font-medium text-gray-700 mb-1">Forfaits disponibles</h3>';
                                            
                                            // Ajouter les forfaits
                                            data.data_plans.forEach(plan => {
                                                const planCard = document.createElement('div');
                                                planCard.className = 'data-plan-card p-3 bg-white border border-gray-200 rounded-lg';
                                                planCard.dataset.planId = plan.id;
                                                planCard.dataset.planPrice = plan.price;
                                                planCard.dataset.planName = plan.name;
                                                
                                                planCard.innerHTML = `
                                                    <div class="flex flex-col h-full">
                                                        <h4 class="font-medium text-gray-800">${plan.name}</h4>
                                                        <p class="text-xs text-gray-500 mb-2">${plan.data_amount} - ${plan.validity} jours</p>
                                                                                            <div class="mt-auto">
                                        <span class="font-bold text-primary-600">${plan.price} €</span>
                                    </div>
                                </div>
                            `;
                            
                            // Ajouter un écouteur d'événements pour la sélection du forfait
                            planCard.addEventListener('click', function() {
                                // Désélectionner tous les forfaits
                                document.querySelectorAll('.data-plan-card').forEach(card => {
                                    card.classList.remove('selected');
                                });
                                
                                // Sélectionner ce forfait
                                this.classList.add('selected');
                                
                                // Mettre à jour le montant
                                amountInput.value = plan.price;
                                
                                // Mettre à jour les variables globales
                                selectedPlanId = plan.id;
                                selectedPlanName = plan.name;
                                
                                // Mettre à jour le récapitulatif
                                updateSummary();
                                
                                // Désélectionner les montants prédéfinis
                                amountPresets.forEach(preset => {
                                    preset.classList.remove('active');
                                });
                            });
                            
                            dataPlansGrid.appendChild(planCard);
                        });
                        
                        // Afficher la grille
                        dataPlansGrid.style.display = 'grid';
                    } else {
                        // Masquer la grille si aucun forfait n'est disponible
                        dataPlansGrid.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des forfaits:', error);
                    loadingIndicator.style.display = 'none';
                    dataPlansGrid.style.display = 'none';
                });
        }
        
        // Écouteur d'événements pour le changement d'opérateur
        operatorSelect.addEventListener('change', function() {
            const operatorId = this.value;
            loadDataPlans(operatorId);
            updateSummary();
            
            // Réinitialiser la sélection de forfait
            selectedPlanId = null;
            selectedPlanName = null;
        });
        
        // Écouteurs d'événements pour les montants prédéfinis
        amountPresets.forEach(preset => {
            preset.addEventListener('click', function() {
                // Désélectionner tous les montants
                amountPresets.forEach(p => p.classList.remove('active'));
                
                // Sélectionner ce montant
                this.classList.add('active');
                
                // Mettre à jour le champ de montant
                amountInput.value = this.dataset.amount;
                
                // Désélectionner les forfaits
                document.querySelectorAll('.data-plan-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // Réinitialiser la sélection de forfait
                selectedPlanId = null;
                selectedPlanName = null;
                
                // Mettre à jour le récapitulatif
                updateSummary();
            });
        });
        
        // Écouteurs d'événements pour les contacts récents
        recentContacts.forEach(contact => {
            contact.addEventListener('click', function() {
                phoneNumberInput.value = this.dataset.number;
                updateSummary();
            });
        });
        
        // Écouteurs d'événements pour les champs de formulaire
        phoneNumberInput.addEventListener('input', updateSummary);
        amountInput.addEventListener('input', function() {
            // Désélectionner les montants prédéfinis
            amountPresets.forEach(preset => {
                preset.classList.remove('active');
            });
            
            // Désélectionner les forfaits
            document.querySelectorAll('.data-plan-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Réinitialiser la sélection de forfait
            selectedPlanId = null;
            selectedPlanName = null;
            
            updateSummary();
        });
        
        // Écouteur d'événements pour la soumission du formulaire
        rechargeForm.addEventListener('submit', function(e) {
            // Vérifier si les champs obligatoires sont remplis
            if (!operatorSelect.value || !phoneNumberInput.value || !amountInput.value) {
                e.preventDefault();
                alert('Veuillez remplir tous les champs obligatoires.');
                return;
            }
            
            // Afficher l'indicateur de chargement
            loadingIndicator.style.display = 'flex';
            
            // Ajouter le forfait sélectionné au formulaire si nécessaire
            if (selectedPlanId) {
                const planInput = document.createElement('input');
                planInput.type = 'hidden';
                planInput.name = 'data_plan_id';
                planInput.value = selectedPlanId;
                this.appendChild(planInput);
            }
        });
        
        // Gestion du clavier numérique
        contactsBtn.addEventListener('click', function() {
            numpadModal.classList.remove('hidden');
            numpadInput.value = phoneNumberInput.value;
        });
        
        closeNumpadBtn.addEventListener('click', function() {
            numpadModal.classList.add('hidden');
        });
        
        numpadKeys.forEach(key => {
            key.addEventListener('click', function() {
                const keyValue = this.dataset.key;
                
                if (keyValue === 'backspace') {
                    numpadInput.value = numpadInput.value.slice(0, -1);
                } else {
                    numpadInput.value += keyValue;
                }
            });
        });
        
        confirmNumpadBtn.addEventListener('click', function() {
            phoneNumberInput.value = numpadInput.value;
            numpadModal.classList.add('hidden');
            updateSummary();
        });
        
        // Fermer le modal en cliquant en dehors
        numpadModal.addEventListener('click', function(e) {
            if (e.target === numpadModal) {
                numpadModal.classList.add('hidden');
            }
        });
        
        // Initialiser le formulaire
        if (operatorSelect.value) {
            loadDataPlans(operatorSelect.value);
        }
        
        // Initialiser le récapitulatif
        updateSummary();
    });
</script>
{% endblock %}
